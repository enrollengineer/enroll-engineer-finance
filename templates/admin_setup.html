<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow Pro - Admin Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="min-h-screen flex items-center justify-center" style="background-color: #D9D4D4;">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
        <div class="text-center mb-6">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-full inline-block mb-4">
                <i class="fas fa-user-cog text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Admin Setup Helper</h1>
            <p class="text-gray-600">Quick setup for your first admin account</p>
        </div>

        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Enter the email you signed up with:</label>
                <input type="email" id="userEmail" placeholder="your-email@example.com" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <button onclick="makeAdmin()" 
                    class="w-full text-white py-3 rounded-lg transition-all duration-300 font-semibold" style="background-color: #002F6C; hover:background-color: #001f4a;" onmouseover="this.style.backgroundColor='#001f4a'" onmouseout="this.style.backgroundColor='#002F6C'">
                <i class="fas fa-magic mr-2"></i>Make Me Admin
            </button>

            <div id="status" class="text-center text-sm"></div>

            <hr class="border-gray-200">

            <div class="text-center">
                <p class="text-sm text-gray-600 mb-3">All users in database:</p>
                <div class="flex space-x-2 justify-center mb-4">
                    <button onclick="loadUsers()" 
                            class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                        <i class="fas fa-refresh mr-2"></i>Load Users
                    </button>
                    <button onclick="showUnblockEmailForm()" 
                            class="bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200 transition-colors">
                        <i class="fas fa-unlock mr-2"></i>Unblock Email
                    </button>
                    <!-- Link to the approval tool -->
                    <a href="/admin/approve-user" 
                       class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                        <i class="fas fa-users-cog mr-2"></i>Open Approval Tool
                    </a>
                </div>
                
                <!-- Unblock Email Form (Initially Hidden) -->
                <div id="unblockEmailForm" class="hidden mb-4 p-4 bg-green-50 rounded-lg border border-green-200">
                    <h3 class="text-sm font-semibold text-green-800 mb-2">Unblock Email for Signup</h3>
                    <p class="text-xs text-green-600 mb-3">Enter email to make it available for fresh registration:</p>
                    <div class="flex space-x-2">
                        <input type="email" id="unblockEmailInput" placeholder="email@example.com" 
                               class="flex-1 px-3 py-2 text-sm border border-green-300 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        <button onclick="unblockEmail()" 
                                class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                            <i class="fas fa-unlock mr-1"></i>Unblock
                        </button>
                        <button onclick="hideUnblockEmailForm()" 
                                class="bg-gray-400 text-white px-3 py-2 rounded text-sm hover:bg-gray-500">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                    </div>
                </div>
                
                <div id="usersList" class="mt-4 space-y-2"></div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="index_complete.html" class="text-blue-600 hover:text-blue-800 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>Back to FinanceFlow Pro
            </a>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            status.className = `text-center text-sm ${colors[type]}`;
            status.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'} mr-2"></i>${message}`;
        }

        async function makeAdmin() {
            const email = document.getElementById('userEmail').value.trim();
            if (!email) {
                showStatus('Please enter an email address', 'error');
                return;
            }

            try {
                showStatus('Searching for user...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());

                if (!user) {
                    showStatus('User not found. Please sign up first in the main app.', 'error');
                    return;
                }

                const updateResponse = await fetch(`${API_BASE_URL}/admin/users/${user.uid}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'Admin' })
                });

                if (!updateResponse.ok) {
                    throw new Error(`HTTP ${updateResponse.status}: ${updateResponse.statusText}`);
                }

                showStatus('âœ… Success! You are now an Admin. Go back and login!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'index_complete.html';
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function loadUsers() {
            try {
                showStatus('Loading users...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';

                if (!users || users.length === 0) {
                    usersList.innerHTML = '<p class="text-gray-500 text-sm">No users found. Sign up first!</p>';
                    showStatus('No users in database', 'info');
                    return;
                }

                let visibleCount = 0;

                users.forEach((user) => {
                    // Only show users that are not rejected (skip rejected users completely)
                    if (user.status === 'rejected') {
                        return; // Skip this user, don't display rejected users
                    }
                    
                    visibleCount++;
                    
                    const userDiv = document.createElement('div');
                    userDiv.className = 'bg-gray-50 p-3 rounded-lg text-left';
                    userDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-sm">${user.email}</div>
                                <div class="text-xs text-gray-500">${user.name || 'No name'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-medium ${
                                    user.status === 'approved' ? 'text-green-600' : 
                                    user.status === 'pending' ? 'text-yellow-600' : 'text-red-600'
                                }">${user.status}</div>
                                <div class="text-xs text-gray-500">${user.role}</div>
                            </div>
                        </div>
                        ${user.status === 'pending' ? `
                            <div class="mt-2 space-y-2">
                                <select id="roleSelect_${user.uid}" class="w-full text-xs border border-gray-300 rounded px-2 py-1">
                                    <option value="Admin">Admin</option>
                                    <option value="Manager">Manager</option>
                                    <option value="User" selected>User</option>
                                </select>
                                <div class="flex space-x-2">
                                    <button onclick="approveUser('${user.uid}', '${user.email}')" 
                                            class="flex-1 bg-green-100 text-green-700 px-2 py-1 rounded text-xs hover:bg-green-200">
                                        Approve
                                    </button>
                                    <button onclick="rejectUser('${user.uid}', '${user.email}')" 
                                            class="flex-1 bg-red-100 text-red-700 px-2 py-1 rounded text-xs hover:bg-red-200">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        ` : user.status === 'approved' ? `
                            <button onclick="revokeUser('${user.uid}', '${user.email}')" 
                                    class="mt-2 w-full bg-red-100 text-red-700 px-2 py-1 rounded text-xs hover:bg-red-200">
                                Revoke Access
                            </button>
                        ` : ''}
                    `;
                    usersList.appendChild(userDiv);
                });

                showStatus(`Found ${visibleCount} active users`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error loading users: ' + error.message, 'error');
            }
        }

        async function approveUser(userId, email) {
            try {
                const roleSelect = document.getElementById(`roleSelect_${userId}`);
                const selectedRole = roleSelect ? roleSelect.value : 'User';
                
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}/approve`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: selectedRole })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                showStatus(`âœ… ${email} is now approved as ${selectedRole}!`, 'success');
                loadUsers(); // Reload the list
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function rejectUser(userId, email) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}/reject`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                showStatus(`âŒ ${email} rejected! Use 'Unblock Email' to make it available again.`, 'success');
                loadUsers(); // Reload the list
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function revokeUser(userId, email) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                showStatus(`ðŸš« Access revoked for ${email}! Use 'Unblock Email' to make it available again.`, 'success');
                loadUsers(); // Reload the list
            } catch (error) {
                console.error('Error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Unblock Email Functions
        function showUnblockEmailForm() {
            document.getElementById('unblockEmailForm').classList.remove('hidden');
            document.getElementById('unblockEmailInput').focus();
        }
        
        function hideUnblockEmailForm() {
            document.getElementById('unblockEmailForm').classList.add('hidden');
            document.getElementById('unblockEmailInput').value = '';
        }
        
        async function unblockEmail() {
            const email = document.getElementById('unblockEmailInput').value.trim();
            if (!email) {
                showStatus('Please enter an email address', 'error');
                return;
            }
            
            try {
                showStatus('Unblocking email...', 'info');
                
                // Call backend API to unblock email
                const response = await fetch(`${API_BASE_URL}/admin/unblock-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                showStatus(`âœ… ${email} is now unblocked and available for signup!`, 'success');
                hideUnblockEmailForm();
                
            } catch (error) {
                console.error('Error unblocking email:', error);
                showStatus('Error unblocking email: ' + error.message, 'error');
            }
        }
        
        // Load users on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });
    </script>
</body>
</html>
